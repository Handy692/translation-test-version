<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ç¿»è¯‘å†å² - è‹±è¯­ç¿»è¯‘ç»ƒä¹ ç½‘ç«™</title>
    <link rel="stylesheet" href="styles.css?v=4">
</head>
<body>
    <div class="container">
        <header>
            <div class="header-left">
                <h1>è‹±è¯­ç¿»è¯‘ç»ƒä¹ </h1>
                <div class="timer" id="timer" style="display: none;">00:00:00</div>
            </div>
            <div class="header-right">
                <a href="index.html" class="home-btn flat-btn" title="è¿”å›ä¸»é¡µ">ğŸ </a>
                <a href="wordbook.html" id="wordbook-icon" class="wordbook-icon" title="å•è¯æœ¬">ğŸ“š</a>
                <a href="translation-history.html" id="history-icon" class="history-btn flat-btn" title="ç¿»è¯‘å†å²">ğŸ“œ</a>
            </div>
        </header>

        <!-- ç¿»è¯‘å†å²é¡µé¢ -->
        <section id="translation-history" class="active">
            <h2>ç¿»è¯‘å†å²</h2>
            
            <!-- ç¿»è¯‘æ–‡ç« å†å²ç‰ˆæœ¬åŒºåŸŸ -->
            <div class="history-section">
                <h3>ç¿»è¯‘æ–‡ç« å†å²ç‰ˆæœ¬</h3>
                <div class="history-controls">
                    <button id="export-history-btn" class="back-btn">å¯¼å‡ºå†å²æ•°æ®</button>
                    <label for="import-history-file" class="back-btn" style="cursor: pointer; display: inline-block; margin-left: 10px;">å¯¼å…¥å†å²æ•°æ®</label>
                    <input type="file" id="import-history-file" accept=".json" style="display: none;">
                    <button id="clear-history-versions-btn" class="back-btn" style="margin-left: 10px; background-color: #ff4444;">æ¸…ç©ºæ‰€æœ‰å†å²ç‰ˆæœ¬</button>
                </div>
                <div id="history-versions-list" class="history-list">
                    <!-- å†å²ç‰ˆæœ¬è®°å½•å°†é€šè¿‡JavaScriptåŠ¨æ€ç”Ÿæˆ -->
                    <div class="no-history-message">æš‚æ— ç¿»è¯‘æ–‡ç« å†å²ç‰ˆæœ¬è®°å½•</div>
                </div>
            </div>
            
            <!-- å†å²ç¿»è¯‘æ–‡ç« åŒºåŸŸ -->
            <div class="history-section">
                <h3>å†å²ç¿»è¯‘æ–‡ç« </h3>
                <div class="history-controls">
                    <button id="clear-history-files-btn" class="back-btn" style="background-color: #ff4444;">æ¸…ç©ºæ‰€æœ‰å†å²æ–‡ä»¶</button>
                </div>
                <div id="history-files-list" class="history-list">
                    <!-- å†å²æ–‡ä»¶è®°å½•å°†é€šè¿‡JavaScriptåŠ¨æ€ç”Ÿæˆ -->
                    <div class="no-history-message">æš‚æ— å†å²ç¿»è¯‘æ–‡ç« è®°å½•</div>
                </div>
            </div>
        </section>
    </div>

    <!-- ç‰ˆæƒä¿¡æ¯ -->
    <footer class="footer">
        <p class="copyright">æœ¬ç½‘é¡µç”±AIç”Ÿæˆï¼Œç”Ÿæˆè€…æœ¬äººä¸æ‡‚ç½‘é¡µå¼€å‘ï¼Œæœ€åˆç›®æ ‡åªæ˜¯è‡ªç”¨ï¼Œå¤§ç¥æµ·æ¶µ</p>
    </footer>

    <script src="script.js?v=4"></script>
    <!-- ä¸»é¢˜åˆ‡æ¢æŒ‰é’® -->
    <button id="theme-toggle-btn" class="theme-toggle-btn" title="æ›´æ¢ä¸»é¢˜" aria-label="æ›´æ¢ä¸»é¢˜" aria-expanded="false">ğŸ¨</button>
    
    <!-- æ¨¡å¼åˆ‡æ¢æŒ‰é’® -->
    <button id="mode-toggle-btn" class="mode-toggle-btn" title="åˆ‡æ¢é»‘æš—/ç™½å¤©æ¨¡å¼" aria-label="åˆ‡æ¢é»‘æš—/ç™½å¤©æ¨¡å¼" aria-pressed="false">ğŸŒ™</button>
    
    <!-- ä¸»é¢˜é€‰æ‹©é¢æ¿ -->
    <div id="theme-panel" class="theme-panel hidden" role="menu" aria-labelledby="theme-toggle-btn">
        <div class="theme-panel-header">
            <h3>é€‰æ‹©ä¸»é¢˜</h3>
            <button id="close-theme-panel" class="close-btn" aria-label="å…³é—­ä¸»é¢˜é¢æ¿">&times;</button>
        </div>
        <div class="theme-colors">
            <h4>ä¸»é¢˜é¢œè‰²</h4>
            <div class="color-options">
                <button class="color-option" data-color="blue" style="background-color: #2196F3" title="è“è‰²ä¸»é¢˜" aria-pressed="false"></button>
                <button class="color-option" data-color="red" style="background-color: #F44336" title="çº¢è‰²ä¸»é¢˜" aria-pressed="false"></button>
                <button class="color-option" data-color="yellow" style="background-color: #FFC107" title="é»„è‰²ä¸»é¢˜" aria-pressed="false"></button>
                <button class="color-option" data-color="green" style="background-color: #4CAF50" title="ç»¿è‰²ä¸»é¢˜" aria-pressed="false"></button>
                <button class="color-option" data-color="purple" style="background-color: #9C27B0" title="ç´«è‰²ä¸»é¢˜" aria-pressed="false"></button>
            </div>
        </div>
    </div>
    <script>
        // ç¿»è¯‘å†å²é¡µé¢ç‰¹å®šåŠŸèƒ½
        document.addEventListener('DOMContentLoaded', function() {
            // åˆå§‹åŒ–ç¿»è¯‘å†å²é¡µé¢
            initTranslationHistory();
        });

        // åˆå§‹åŒ–ç¿»è¯‘å†å²é¡µé¢
        function initTranslationHistory() {
            // åŠ è½½ç¿»è¯‘å†å²æ•°æ®
            loadTranslationHistory();
            
            // æ·»åŠ äº‹ä»¶ç›‘å¬å™¨
            setupHistoryEventListeners();
        }

        // åŠ è½½ç¿»è¯‘å†å²æ•°æ®
        function loadTranslationHistory() {
            // åŠ è½½ç¿»è¯‘æ–‡ç« å†å²ç‰ˆæœ¬
            loadHistoryVersions();
            
            // åŠ è½½å†å²ç¿»è¯‘æ–‡ç« 
            loadHistoryFiles();
        }

        // åŠ è½½ç¿»è¯‘æ–‡ç« å†å²ç‰ˆæœ¬
        function loadHistoryVersions() {
            const historyList = document.getElementById('history-versions-list');
            const versions = TranslationHistory.getHistoryVersions();
            
            if (versions.length === 0) {
                historyList.innerHTML = '<div class="no-history-message">æš‚æ— ç¿»è¯‘æ–‡ç« å†å²ç‰ˆæœ¬è®°å½•</div>';
                return;
            }
            
            historyList.innerHTML = versions.map(version => `
                <div class="history-item">
                    <div class="history-item-header">
                        <h4>${version.filename || 'æœªå‘½åæ–‡ä»¶'}</h4>
                        <span class="history-item-date">${new Date(version.timestamp).toLocaleString()}</span>
                    </div>
                    <div class="history-item-content">
                        <p class="history-item-description">${version.description || 'æ— æè¿°'}</p>
                        ${version.passageContent ? `<div class="history-item-passage"><strong>åŸæ–‡ï¼š</strong><p>${version.passageContent.substring(0, 200)}${version.passageContent.length > 200 ? '...' : ''}</p></div>` : ''}
                        ${version.score !== null ? `<div class="history-item-score"><strong>è¯„åˆ†ï¼š</strong>${version.score}/100</div>` : ''}
                        ${version.aiEvaluation ? `<div class="history-item-ai-evaluation"><strong>AIè¯„è¯­ï¼š</strong><p>${version.aiEvaluation.substring(0, 300)}${version.aiEvaluation.length > 300 ? '...' : ''}</p></div>` : ''}
                        <div class="history-item-actions">
                            <button class="back-btn" onclick="loadHistoryVersion('${version.id}')">æŸ¥çœ‹è¯¦æƒ…</button>
                            <button class="back-btn" style="background-color: #ff4444;" onclick="deleteHistoryVersion('${version.id}')">åˆ é™¤</button>
                        </div>
                    </div>
                </div>
            `).join('');
        }

        // åŠ è½½å†å²ç¿»è¯‘æ–‡ç« 
        function loadHistoryFiles() {
            const filesList = document.getElementById('history-files-list');
            const files = TranslationHistory.getHistoryFiles();
            
            if (files.length === 0) {
                filesList.innerHTML = '<div class="no-history-message">æš‚æ— å†å²ç¿»è¯‘æ–‡ç« è®°å½•</div>';
                return;
            }
            
            filesList.innerHTML = files.map(file => `
                <div class="history-item">
                    <div class="history-item-header">
                        <h4>${file.filename || 'æœªå‘½åæ–‡ä»¶'}</h4>
                        <span class="history-item-date">${new Date(file.timestamp).toLocaleString()}</span>
                    </div>
                    <div class="history-item-content">
                        <p class="history-item-description">${file.description || 'æ— æè¿°'}</p>
                        <div class="history-item-actions">
                            <button class="back-btn" onclick="reloadHistoryFile('${file.id}')">é‡æ–°åŠ è½½</button>
                            <button class="back-btn" style="background-color: #ff4444;" onclick="deleteHistoryFile('${file.id}')">åˆ é™¤</button>
                        </div>
                    </div>
                </div>
            `).join('');
        }

        // è®¾ç½®å†å²äº‹ä»¶ç›‘å¬å™¨
        function setupHistoryEventListeners() {
            // å¯¼å‡ºå†å²æ•°æ®
            document.getElementById('export-history-btn').addEventListener('click', exportHistoryData);
            
            // å¯¼å…¥å†å²æ•°æ®
            document.getElementById('import-history-file').addEventListener('change', importHistoryData);
            
            // æ¸…ç©ºæ‰€æœ‰å†å²ç‰ˆæœ¬
            document.getElementById('clear-history-versions-btn').addEventListener('click', clearAllHistoryVersions);
            
            // æ¸…ç©ºæ‰€æœ‰å†å²æ–‡ä»¶
            document.getElementById('clear-history-files-btn').addEventListener('click', clearAllHistoryFiles);
        }

        // åŠ è½½å†å²ç‰ˆæœ¬
        function loadHistoryVersion(versionId) {
            const versions = TranslationHistory.getHistoryVersions();
            const version = versions.find(v => v.id === versionId);
            
            if (version) {
                // å°†å†å²ç‰ˆæœ¬æ•°æ®ä¿å­˜åˆ°sessionStorage
                sessionStorage.setItem('historyVersionToView', JSON.stringify(version));
                
                // è·³è½¬åˆ°è¯„ä»·é¡µé¢
                window.location.href = '4_evaluation.html?historyVersion=true';
            } else {
                showMessage('æœªæ‰¾åˆ°è¯¥å†å²ç‰ˆæœ¬è®°å½•', 'error');
            }
        }

        // åˆ é™¤å†å²ç‰ˆæœ¬
        function deleteHistoryVersion(versionId) {
            if (confirm('ç¡®å®šè¦åˆ é™¤æ­¤å†å²ç‰ˆæœ¬å—ï¼Ÿ')) {
                if (TranslationHistory.deleteHistoryVersion(versionId)) {
                    showMessage('å†å²ç‰ˆæœ¬åˆ é™¤æˆåŠŸï¼', 'success');
                    loadHistoryVersions();
                } else {
                    showMessage('å†å²ç‰ˆæœ¬åˆ é™¤å¤±è´¥ï¼', 'error');
                }
            }
        }

        // é‡æ–°åŠ è½½å†å²æ–‡ä»¶
        function reloadHistoryFile(fileId) {
            const files = TranslationHistory.getHistoryFiles();
            const file = files.find(f => f.id === fileId);
            
            if (file) {
                // å°†æ–‡ä»¶æ•°æ®ä¿å­˜åˆ°sessionStorageï¼Œç„¶åè·³è½¬åˆ°ç›¸åº”çš„ç»ƒä¹ é¡µé¢
                sessionStorage.setItem('reloadedHistoryFile', JSON.stringify(file));
                showMessage('æ­£åœ¨é‡æ–°åŠ è½½å†å²æ–‡ä»¶...', 'info');
                // è·³è½¬åˆ°ä¸Šä¼ é¡µé¢ï¼Œç”±ä¸Šä¼ é¡µé¢å¤„ç†é‡æ–°åŠ è½½é€»è¾‘
                window.location.href = 'index.html?reloadFile=true';
            }
        }

        // åˆ é™¤å†å²æ–‡ä»¶
        function deleteHistoryFile(fileId) {
            if (confirm('ç¡®å®šè¦åˆ é™¤æ­¤å†å²æ–‡ä»¶å—ï¼Ÿ')) {
                if (TranslationHistory.deleteHistoryFile(fileId)) {
                    showMessage('å†å²æ–‡ä»¶åˆ é™¤æˆåŠŸï¼', 'success');
                    loadHistoryFiles();
                } else {
                    showMessage('å†å²æ–‡ä»¶åˆ é™¤å¤±è´¥ï¼', 'error');
                }
            }
        }

        // æ¸…ç©ºæ‰€æœ‰å†å²ç‰ˆæœ¬
        function clearAllHistoryVersions() {
            if (confirm('ç¡®å®šè¦æ¸…ç©ºæ‰€æœ‰ç¿»è¯‘æ–‡ç« å†å²ç‰ˆæœ¬å—ï¼Ÿæ­¤æ“ä½œä¸å¯æ¢å¤ï¼')) {
                if (TranslationHistory.clearAllHistoryVersions()) {
                    showMessage('æ‰€æœ‰å†å²ç‰ˆæœ¬å·²æ¸…ç©ºï¼', 'success');
                    loadHistoryVersions();
                } else {
                    showMessage('æ¸…ç©ºå†å²ç‰ˆæœ¬å¤±è´¥ï¼', 'error');
                }
            }
        }

        // æ¸…ç©ºæ‰€æœ‰å†å²æ–‡ä»¶
        function clearAllHistoryFiles() {
            if (confirm('ç¡®å®šè¦æ¸…ç©ºæ‰€æœ‰å†å²ç¿»è¯‘æ–‡ç« å—ï¼Ÿæ­¤æ“ä½œä¸å¯æ¢å¤ï¼')) {
                if (TranslationHistory.clearAllHistoryFiles()) {
                    showMessage('æ‰€æœ‰å†å²æ–‡ä»¶å·²æ¸…ç©ºï¼', 'success');
                    loadHistoryFiles();
                } else {
                    showMessage('æ¸…ç©ºå†å²æ–‡ä»¶å¤±è´¥ï¼', 'error');
                }
            }
        }

        // å¯¼å‡ºå†å²æ•°æ®
        function exportHistoryData() {
            const historyData = TranslationHistory.exportHistoryData();
            
            const dataStr = JSON.stringify(historyData, null, 2);
            const dataBlob = new Blob([dataStr], { type: 'application/json' });
            const url = URL.createObjectURL(dataBlob);
            const link = document.createElement('a');
            link.href = url;
            link.download = `translation-history-${new Date().toISOString().split('T')[0]}.json`;
            link.click();
            URL.revokeObjectURL(url);
            
            showMessage('å†å²æ•°æ®å¯¼å‡ºæˆåŠŸï¼', 'success');
        }

        // å¯¼å…¥å†å²æ•°æ®
        function importHistoryData(event) {
            const file = event.target.files[0];
            if (!file) return;
            
            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const historyData = JSON.parse(e.target.result);
                    
                    if (TranslationHistory.importHistoryData(historyData)) {
                        showMessage('å†å²æ•°æ®å¯¼å…¥æˆåŠŸï¼', 'success');
                        loadTranslationHistory();
                    } else {
                        showMessage('å†å²æ•°æ®å¯¼å…¥å¤±è´¥ï¼', 'error');
                    }
                } catch (error) {
                    console.error('Error importing history data:', error);
                    showMessage('å†å²æ•°æ®å¯¼å…¥å¤±è´¥ï¼è¯·æ£€æŸ¥æ–‡ä»¶æ ¼å¼æ˜¯å¦æ­£ç¡®ã€‚', 'error');
                }
            };
            reader.readAsText(file);
            
            // æ¸…ç©ºæ–‡ä»¶è¾“å…¥
            event.target.value = '';
        }

        // æ˜¾ç¤ºæ¶ˆæ¯æç¤º
        function showMessage(message, type = 'info') {
            // åˆ›å»ºæ¶ˆæ¯å…ƒç´ 
            const messageEl = document.createElement('div');
            messageEl.className = `message ${type}`;
            messageEl.textContent = message;
            
            // æ·»åŠ åˆ°é¡µé¢
            document.body.appendChild(messageEl);
            
            // æ˜¾ç¤ºæ¶ˆæ¯
            setTimeout(() => {
                messageEl.style.opacity = '1';
            }, 100);
            
            // 3ç§’åéšè—æ¶ˆæ¯
            setTimeout(() => {
                messageEl.style.opacity = '0';
                setTimeout(() => {
                    document.body.removeChild(messageEl);
                }, 300);
            }, 3000);
        }
        </script>
</body>
</html>